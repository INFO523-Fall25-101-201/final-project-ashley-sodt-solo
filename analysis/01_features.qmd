---
title: "Session-level Features (Trot Only)"
format:
  html:
    code-tools: true
    code-overflow: wrap
    code-line-numbers: true
    embed-resources: true
execute:
  warning: false
  message: false
jupyter: python3
---

```{python}
#| label: summarize-session
#| message: false

from pathlib import Path
import pandas as pd

# Variables to keep
TROT_VARS = [
    "stride_dur","stride_speed","stride_length",
    "duty_factor",
    "duty_factor_LF","duty_factor_RF","duty_factor_LH","duty_factor_RH",
    "stance_dur_LF","stance_dur_RF","stance_dur_LH","stance_dur_RH",
    "dap_L_sec","dap_L_perc","dap_R_sec","dap_R_perc",
    "min_diff_head","max_diff_head","si_up_head",
    "min_diff_wth","max_diff_wth","si_up_wth",
    "min_diff_sac","max_diff_sac","si_up_sac"
]

def summarize_session(csv_path: Path, horse: str) -> pd.Series:
    """Summarize a single EquiPro session (trot only)."""

    df = pd.read_csv(csv_path)
    df.columns = df.columns.str.strip()

    # Filter to trot only
    if "gait" in df.columns:
        df = df[df["gait"].str.lower() == "trot"]

    # Extract session ID
    stem = csv_path.stem
    session_id = stem.replace(f"-{horse}-results", "")

    stats = {}

    for col in TROT_VARS:
        if col not in df.columns:
            continue

        s = df[col].dropna()
        if s.empty:
            continue

        q1, q3 = s.quantile([0.25, 0.75])

        stats[f"{col}_mean"] = s.mean()
        stats[f"{col}_std"] = s.std()
        stats[f"{col}_iqr"] = q3 - q1
        stats[f"{col}_min"] = s.min()
        stats[f"{col}_max"] = s.max()

    stats["horse"] = horse
    stats["session_id"] = session_id
    stats["n_rows"] = len(df)

    return pd.Series(stats)
```

```{python}
#| label: build-feature-matrix
#| message: false

HORSES = ["Duque", "Jackson", "Perseo"]
HORSES_DIR = Path("..") / "Horses"

rows = []

for horse in HORSES:
    horse_dir = HORSES_DIR / horse
    csv_files = sorted(horse_dir.glob("*-results.csv"))
    print(f"{horse}: {len(csv_files)} sessions")

    for csv_path in csv_files:
        row = summarize_session(csv_path, horse)
        rows.append(row)

session_features = pd.DataFrame(rows)

meta_cols = ["horse","session_id","n_rows"]
other_cols = [c for c in session_features.columns if c not in meta_cols]
session_features = session_features[meta_cols + other_cols]

session_features.head()
```

```{python}
#| label: save
#| message: false

out = Path("data") / "session_features_trot.csv"
out.parent.mkdir(exist_ok=True)
session_features.to_csv(out, index=False)
print(f"Saved: {out}")
```
