---
title: "Clustering Movement Patterns in Equine Exercise Sessions"
subtitle: "INFO 523 - Fall 2025 - Final Project"
author: "Ashley Sodt"
title-slide-attributes:
  data-background-image: images/watercolour_sys02_img34_teacup-ocean.jpg
  data-background-size: stretch
  data-background-opacity: "0.7"
  data-slide-number: none
format:
  revealjs:
    theme:  ['data/customtheming.scss']
  
editor: visual
jupyter: python3
execute:
  echo: false
---

```{python}
#| label: load-packages
#| include: false

# Load packages here
import pandas as pd
import seaborn as sns

```

```{python}
#| label: setup
#| include: false
#| 
# Set up plot theme and figure resolution
sns.set_theme(style="whitegrid")
sns.set_context("notebook", font_scale=1.1)

import matplotlib.pyplot as plt
plt.rcParams['figure.dpi'] = 300
plt.rcParams['savefig.dpi'] = 300
plt.rcParams['figure.figsize'] = (6, 6 * 0.618)
```

```{python}
#| label: load-data
#| include: false
# Load data in Python
mtcars = sns.load_dataset('mpg').dropna()  # mtcars dataset is similar to the mpg dataset from seaborn
mtcars['speed'] = mtcars['horsepower'] / mtcars['weight']

penguins = sns.load_dataset('penguins').dropna()
```

## Introduction

-   Al-Marah Equine Center // Laura Miller

* EquiPro intertial measurement units collect accelerometer data
  + Outputs stride-level biomechanical metrics
  + Early detection of subtle gait abnormalities

**Goal**: Use unsupervised learning techniques to model each horse's typical movement and automatically flag exercise sessions that deviate from this baseline. Such anomalies may reflect behavioral irregularities, equipment
malfunction, pain, or potential reinjury.

## Dataset

* Each session exported as CSV containing stride-level movemement variables.
  + Duque (14 sessions)
  + Jackson (6 sessions)
  + Perseo (5 sessions)

## Dataset {.smaller}
Sample of Equipro CSV output with stride-level biomechanical metrics from one exercise session.

```{python}
#| label: duque-head
#| warning: false
# Load one example Duque session

df_duque = pd.read_csv("Horses/Duque/20240626T082743-Duque-results.csv")

df_duque = pd.read_csv("Horses/Duque/20240626T082743-Duque-results.csv")
df_duque.head().style.set_properties(**{'font-size':'5px'})

# Show first 5 rows
df_duque.head()
```

# Methods

## Session-Level Features {.smaller}

We summarize 25 stride-level variables into session-level features.

| Group                     | Biomechanical Variables                                    | Count |
|-------------------------:|:------------------------------------------------------|------:|
| **Stride Metrics**        | stride duration, speed, length                        | 3     |
| **Limb Loading / Timing** | duty factor (LF/RF/LH/RH), stance durations           | 12    |
| **Coordination**    | diagonal advanced placement (left / right)            | 4     |
| **Trunk Symmetry**        | head / withers / sacrum asymmetry + symmetry indices  | 6     |
| **Total**                 | —                                                     | **25** |

→ Each variable is summarized per session using: mean, std, IQR, min, max 

→ Producing 125 engineered features per session


## Session-Level Feature Matrix {.smaller}

Feature matrix containing 24 exercise sessions and 125 engineered biomechanical movement features per session.

```{python}
import pandas as pd
from pathlib import Path

# Load the engineered feature matrix
data_path = Path("analysis") / "data" / "session_features_trot.csv"
session_features = pd.read_csv(data_path)

# Rows to display
rows_to_show = [1, 2, 16, 17, 22, 23]

display_cols = [
    "horse", "session_id", "n_rows",
    "stride_dur_mean", "stride_dur_std",
    "stride_dur_iqr","stride_dur_min","stride_dur_max"
]

# Display selected rows, clean formatting
session_features.loc[rows_to_show, display_cols] \
    .style.hide(axis="index") 
```

## Anomaly Detection Framework

- Convert every feature to a z-score.

- **Z-score Thresholding**: Flags sessions where any feature deviates strongly from the horse’s baseline.

- **K-means Cluster Distance**: Groups similar sessions and marks those far from their cluster center as outliers.

- **Isolation Forest**: Identifies sessions that are difficult to group with others (unusual combinations of features).

Sessions flagged by multiple methods are more likely to reflect real gait irregularities.

# Results

## Anomalies Flagged by Individual Methods

| Method               | Duque | Jackson | Perseo |
|---------------------|:-----:|:-------:|:------:|
| Z-score threshold   | **7** | 0 | 0 |
| K-means distance    | **3** | **2** | **2** |
| Isolation Forest    | **4** | **2** | 0 |




## High-Confidence Anomalies {.smaller}

Sessions flagged by ≥2 methods (strongest evidence of abnormal movement):

| Horse   | Session ID       |  Methods Flagged |
|--------|-------------------|:----------------:|
| Duque   | 20250804T082647  | **3** |
| Duque   | 20250309T134916  | **3** |
| Duque   | 20250308T111144  | **3** |
| Duque   | 20240627T095239  | **2** |
| Jackson | 20241215T152135  | **2** |

These sessions consistently deviate from each horse’s typical movement pattern.



## Method Agreement Heatmap

<div align="center">
![Which methods agree when flagging anomalies?](analysis/data/fig_method_heatmap.png){width="50%"}
</div>

## Max Deviation from Baseline {.smaller}

<div align="center">

![Which sessions show the largest single-feature deviation?](analysis/data/fig_max_zscore.png){width="80%"}

</div>

<div align="center">
![Which methods agree when flagging anomalies?](analysis/data/fig_method_heatmap.png){width="50%"}
</div>

## Feature Drivers of High-Confidence Anomalies {.smaller}

<div align="center">

![](analysis/data/fig_top_feature_heatmap.png){width="100%"}

</div>


## Interpreting Anomaly Drivers — Example: Duque 08/04/25 {.smaller}

**Top contributing features**

- ↑ Right Hind stance duration (stance_dur_RH_max)

- ↑ Diagonal timing variability (DAP metrics: dap_L_perc_iqr, dap_R_sec_max)

**What this suggests**

- Right hind is staying on the ground longer → compensation

- Increased timing variability → reduced trot symmetry & coordination

**Likely interpretation**

Right hind is supporting more load, causing instability in diagonal pairing.  
This may indicate early hind-limb discomfort or fatigue.


## Conclusions {.smaller}

- Computed session-level biomechanics for each horse → established individualized baseline movement patterns
- Multiple anomaly detection methods (Z-score, K-means, Isolation Forest) flagged sessions showing deviations from baseline
- Only a small subset of sessions showed strong evidence of abnormality  
  - High-confidence anomalies = flagged by ≥ 2 methods

- Deviations were driven primarily by:
  - Diagonal advanced placement, duty factor, and head motion symmetry
  - Features tied to stride timing and weight distribution

<div style="margin-top:10px; font-size:0.9em;">
**Interpretation:**  
Automated anomaly detection reveals subtle, horse-specific gait changes that may signal behavioral irregularities, equipment issues, 
pain responses, or early reinjury risk. This can enable earlier detection and proactive intervention.
</div>